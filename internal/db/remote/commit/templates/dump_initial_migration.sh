#!/usr/bin/env bash
set -euo pipefail

# Explanation of special flags:
#
#   --schema-only     omit data like migration history, pgsodium key, etc.
#   --exclude-schema  omit internal schemas as they are maintained by platform
#   --no-comments     only object owner can set comment, omit to allow restore by non-superuser
#   --extension '*'   prevents event triggers from being dumped, bash escaped with single quote
pg_dump \
    --schema-only \
    --quote-all-identifier \
    --exclude-schema "$EXCLUDED_SCHEMAS" \
    --extension '*' \
    --no-comments \
    --dbname "$DB_URL" \
| sed 's/ALTER DEFAULT PRIVILEGES FOR ROLE "supabase_admin"/-- ALTER DEFAULT PRIVILEGES FOR ROLE "supabase_admin"/' \
| sed 's/GRANT ALL ON FUNCTION "graphql_public"/-- GRANT ALL ON FUNCTION "graphql_public"/' \
| sed 's/GRANT ALL ON FUNCTION "graphql"/-- GRANT ALL ON FUNCTION "graphql"/' \
| sed 's/CREATE POLICY "cron_job_/-- CREATE POLICY "cron_job_/'

# Reset session config generated by pg_dump
echo "RESET ALL;"
