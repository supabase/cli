data_dir: /var/lib/vector
sources:
  gotrue_journald:
    type: journald
    current_boot_only: true
    include_units:
      - gotrue.service
  postgrest_journald:
    type: journald
    current_boot_only: true
    include_units:
      - postgrest.service
transforms:
  filter_postgrest_stats:
    type: filter
    inputs:
      - postgrest_journald
    condition: >-
      !starts_with!(.message, "+") && !starts_with!(.message, "INFO:") && !contains!(.message, "Admin server listening")

  gotrue_to_object:
    inputs:
      - gotrue_journald
    type: remap
    source: |2-
                .project = "project_ref"

                .parsed, err = parse_json(.message)
                if err == null {
                  .metadata = .parsed
                  .metadata.msg = .parsed.msg
                  .timestamp = del(.metadata.time)
                }
                del(.parsed)
                .metadata.host = del(.host)

                del(.source_type)
                del(.PRIORITY)
                del(.SYSLOG_FACILITY)
                del(.SYSLOG_IDENTIFIER)
                del(._BOOT_ID)
                del(._CAP_EFFECTIVE)
                del(._CMDLINE)
                del(._COMM)
                del(._EXE)
                del(._GID)
                del(._MACHINE_ID)
                del(._PID)
                del(._SELINUX_CONTEXT)
                del(._STREAM_ID)
                del(._SYSTEMD_CGROUP)
                del(._SYSTEMD_INVOCATION_ID)
                del(._SYSTEMD_SLICE)
                del(._SYSTEMD_UNIT)
                del(._TRANSPORT)
                del(._UID)
                del(.__MONOTONIC_TIMESTAMP)
                del(.__REALTIME_TIMESTAMP)
  postgrest_to_object:
    inputs:
      - filter_postgrest_stats
    type: remap
    source: |2-
                .project = "project_ref"

                # removes timestamp embedded in log since Vector already sends it
                .message = replace!(.message, r'^\d+/\w+/\d+:\d+:\d+:\d+\s\+\d+:\s', "")
                .metadata.host = del(.host)
                del(.source_type)
                del(.PRIORITY)
                del(.SYSLOG_FACILITY)
                del(.SYSLOG_IDENTIFIER)
                del(._BOOT_ID)
                del(._CAP_EFFECTIVE)
                del(._CMDLINE)
                del(._COMM)
                del(._EXE)
                del(._GID)
                del(._MACHINE_ID)
                del(._PID)
                del(._SELINUX_CONTEXT)
                del(._STREAM_ID)
                del(._SYSTEMD_CGROUP)
                del(._SYSTEMD_INVOCATION_ID)
                del(._SYSTEMD_SLICE)
                del(._SYSTEMD_UNIT)
                del(._TRANSPORT)
                del(._UID)
                del(.__MONOTONIC_TIMESTAMP)
                del(.__REALTIME_TIMESTAMP)
          
sinks:
  http_gotrue:
    type: http
    inputs:
      - gotrue_to_object
    encoding:
      codec: json
    compression: none
    uri: >-
      https://api.logflare.app/logs?api_key=logflare_api_key&source=logflare_source
  http_postgrest:
    type: http
    inputs:
      - postgrest_to_object
    encoding:
      codec: json
    compression: none
    uri: >-
      https://api.logflare.app/logs?api_key=logflare_api_key&source=logflare_postgrest_source

tests:
  - name: Test for the gotrue to object transform
    inputs:
      - insert_at: gotrue_to_object
        type: raw
        value: >-
          time="2021-12-04T07:38:06Z" level=info msg="GoTrue API started on:
          localhost:9999" _SYSTEMD_UNIT="gotrue.service"
    outputs:
      - extract_from: gotrue_to_object
