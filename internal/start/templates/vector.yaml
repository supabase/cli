api:
    enabled: true
    address: "0.0.0.0:9001"

sources:
    docker_syslog:
        type: "syslog"
        address: "0.0.0.0:9000"
        mode: "tcp"
        path: "/tmp/socket"

transforms:
    router:
        type: route
        inputs:
            - docker_syslog
        route:
            kong: '.appname == "{{ .KongId }}"'
            auth: '.appname == "{{ .GotrueId }}"'
            rest: '.appname == "{{ .RestId }}"'
            realtime: '.appname == "{{ .RealtimeId }}"'
            storage: '.appname == "{{ .StorageId }}"'
            db: '.appname == "{{ .DbId }}"'
    auth_logs:
        type: remap
        inputs:
            - router.auth
        source: |-
            .message = parse_json!(.message)
            .event_message = .message.msg
            .metadata.level = .message.level
            .metadata.timestamp = .message.time
            .metadata.app = .appname
            .metadata.ip = .source_ip
            del(.message)
            del(.procid)
            del(.severity)
            del(.source_id)
            del(.source_type)
            del(.timestamp)
            del(.facility)
            del(.host)
            del(.id)
            del(.appname)

sinks:
    logflare_auth:
        type: "http"
        inputs:
            - auth_logs
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        uri: "http://{{ .LogflareId }}:4000/api/logs?source_name=gotrue.logs.prod&api_key={{ .ApiKey }}"
    logflare_realtime:
        type: "http"
        inputs:
            - router.realtime
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        uri: "http://{{ .LogflareId }}:4000/api/logs?source_name=realtime.logs.prod&api_key={{ .ApiKey }}"
    logflare_rest:
        type: "http"
        inputs:
            - router.rest
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        uri: "http://{{ .LogflareId }}:4000/api/logs?source_name=postgREST.logs.prod&api_key={{ .ApiKey }}"
    logflare_db:
        type: "http"
        inputs:
            - router.db
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        # We must route the sink through kong because ingesting logs before logflare is fully initialised will
        # lead to broken queries from studio. This works by the assumption that containers are started in the
        # following order: vector > db > logflare > kong
        uri: "http://{{ .KongId }}:8000/analytics/v1/api/logs?source_name=postgres.logs&api_key={{ .ApiKey }}"
    logflare_storage:
        type: "http"
        inputs:
            - router.storage
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        uri: "http://{{ .LogflareId }}:4000/api/logs?source_name=storage.logs.prod.2&api_key={{ .ApiKey }}"
    logflare_kong:
        type: "http"
        inputs:
            - router.kong
        encoding:
            codec: "json"
        method: "post"
        request:
            retry_max_duration_secs: 10
        uri: "http://{{ .LogflareId }}:4000/api/logs?source_name=cloudflare.logs.prod&api_key={{ .ApiKey }}"
